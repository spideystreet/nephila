---
title: "Guardrails"
description: "Mandatory safety layer — interaction detection, warn node, CIS traceability"
---

## Overview

The guardrail system is **non-negotiable**: it runs before every final LLM response, regardless of what the agent decided. It cannot be bypassed.

## Guardrail Node

`agent/nodes/node_guardrail.py` — executed on every path to a final response.

### What it does

1. Scans `ToolMessage` objects **from the current turn only** (after the last `HumanMessage`, via `last_human_message_idx()`)
2. Extracts lines matching the pattern `[LEVEL] SubstanceA + SubstanceB`
3. Deduplicates mirror pairs (A+B == B+A) and populates `interactions_found` in `AgentState`

```python
# Pattern matched in ToolMessage content
r"\[([^\]]+)\]\s+(.+?)(?:\n|$)"
# → captures: level="Contre-indication", detail="WARFARINE + PARACETAMOL"
```

### Output

```python
{
    "interactions_found": [
        {"niveau_contrainte": "Précaution d'emploi", "detail": "WARFARINE + PARACETAMOL"}
    ]
}
```

## Routing: `should_warn`

After the guardrail node, a conditional edge routes to either `warn` or `response`:

```python
# CRITICAL_LEVELS defined in model_state.py and imported by both guardrail and warn nodes
CRITICAL_LEVELS = frozenset({"contre-indication", "association déconseillée"})

def should_warn(state: AgentState) -> str:
    for interaction in state.get("interactions_found", []):
        if interaction.get("niveau_contrainte", "").lower() in CRITICAL_LEVELS:
            return "warn"
    return "response"
```

| Constraint Level | Route |
|-----------------|-------|
| `Contre-indication` | → `warn` (blocks response) |
| `Association déconseillée` | → `warn` (blocks response) |
| `Précaution d'emploi` | → `response` (with warning in message) |
| `A prendre en compte` | → `response` (informational) |

## Warn Node

`agent/nodes/node_warn.py` — fires when a critical interaction is detected.

The warn node **prepends** a concise inline warning to the agent's response. It replaces the last AI message with a prefixed version:

```
⚠️ Contre-indication — SUBSTANCE_A + SUBSTANCE_B · Association déconseillée — SUBSTANCE_C + SUBSTANCE_D

[original agent response]
```

## Response Node

`agent/nodes/node_response.py` — fires when no critical interaction is detected.

Responsibilities:
1. Extract `source_cis` from `ToolMessage` content (first CIS code found)
2. Populate `AgentState.source_cis` for traceability
3. Pass through the LLM's answer (with any non-critical interaction warnings)

## CIS Traceability

Every final response — whether from `response` or `warn` — must have `source_cis` set. This ensures that:
- Every answer is traceable to a specific drug specialty
- Audit logs can reference the exact BDPM record used
- The RCP link is tied to a known CIS code

## Guardrail Rules Summary

| Rule | Enforcement |
|------|-------------|
| `check_interactions` called before response | System prompt + guardrail ToolMessage scan |
| Critical interactions block the response | `should_warn` conditional edge |
| Every response cites the RCP | System prompt + `response` node |
| Every response has `source_cis` | `response` and `warn` nodes |
| No direct medical advice | System prompt |
